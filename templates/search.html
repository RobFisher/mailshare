{% load dajaxice_templatetags %}

<html>
<head>
<title>Mailshare Search</title>
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}mailshare.css" />
<script src="{{ STATIC_URL }}jquery.js"></script>
{% dajaxice_js_import %}
<script src="{{ STATIC_URL }}jquery.dajax.core.js" type="text/javascript" charset="utf-8"></script>

<script>
function get_email_body_element(email_id) {
    element_selector = "#body_" + email_id;
    return $(element_selector)
}

function scroll_to_position(position) {
    /* http://twigstechtips.blogspot.com/2010/02/jquery-animated-scroll-to-element.html */
    $('html,body').animate({ scrollTop: position },
        { duration: 'slow', easing: 'swing'});
}

function scroll_to_row(element) {
    body_row = element.parent();
    hidden_height = body_row.offset().top + body_row.height() -
        ($(window).scrollTop() + $(window).height());
    if(hidden_height > 0) {
        header_row = body_row.prev();
        if((body_row.height() + header_row.height()) < $(window).height()) {
            scroll_to_position($(window).scrollTop() + hidden_height);
        }
        else {
            scroll_to_position(header_row.offset().top);
        }
    }
}

function toggle_email_body(email_id) {
    element = get_email_body_element(email_id);
    if(element.hasClass("empty")) {
        element.toggleClass("empty showing");
        fetch_email(email_id, $(element));
    }
    else if(element.hasClass("shown")) {
        element.toggleClass("shown hidden");
    }
    else if(element.hasClass("hidden")) {
        element.toggleClass("hidden shown");
        scroll_to_row(element);
    }
}

function fetch_email(email_id) {
    Dajaxice.mailshare.mailshareapp.expand_email(Dajax.process,{'email_id':email_id})
}

function set_email_body(data) {
    element = get_email_body_element(data.email_id);
    element.html(data.email_body);
    element.toggleClass("showing shown");
    scroll_to_row(element);
}
</script>

</head>
<body>
<h1><a href="/">Mailshare Search</a></h1>
<form action="/search/" name="search" method="GET">
<input id="query" name="query" value="{{ search_query }}" />
<input id="submit" type="submit" value="Search" />
</form>

<div class="search_details">
{% if sender_html %}
    <div class="search_sender"><p>Sender is {% autoescape off %}{{ sender_html }}{% endautoescape %}</p></div>
{% endif %}
{% if tag_html %}
    <div class="search_tag"><p>Contains tag {% autoescape off %}{{ tag_html }}{% endautoescape %}</p></div>
{% endif %}
</div>

{% if results %}
    <table>
    {% for result in results %}
        <tr onclick="toggle_email_body({{ result.id }})" class="mailhead {% cycle 'odd' 'even' %}">
            <td>{{ result.date }}</td>
            <td>{{ result.sender }}</td>
            <td>{{ result.subject }}</td>
        </tr>
	<tr>
	  <td colspan="3" class="mailbody empty" id="body_{{ result.id }}">Email body</td>
	</tr>
    {% endfor %}
    </table>
{% else %}
    <p>No results found.</p>
{% endif %}
</form>    
</body>
</html>
